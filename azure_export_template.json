{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.13.1.58284",
      "templateHash": "13120038605368246703"
    }
  },
  "parameters": {
    "exportName": {
      "type": "string",
      "defaultValue": "[concat('lm-cm-export', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "The name of the Azure Cost Management Export"
      }
    },
    "exportStartFrom": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-ddTHH:mm:ssZ')]",
      "metadata": {
        "description": "The start date of the Azure Cost Management Export"
      }
    },    
    "storageAccountId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "Description": "The resource id of the Storage account"
      }
    },
    "storageAccountContainer": {
      "type": "string",
      "defaultValue": "[concat('lm-cm-export-container', uniqueString(resourceGroup().id))]",
      "metadata": {
        "Description": "The name of the Container for the Cost Management Exports"
      }
    },
    "storageAccountDirectory": {
      "type": "string",
      "defaultValue": "lm-cm-exports",
      "metadata": {
        "Description": "The name of the directory for the Cost Management Exports"
      }
    }    
  },
  "resources": [
    {
      "type": "Microsoft.CostManagement/exports",
      "apiVersion": "2022-10-01",
      "name": "[parameters('exportName')]",
      "properties": {
          "schedule": {
            "status": "Active",
            "recurrence": "Daily",
            "recurrencePeriod": {
              "from": "[parameters('exportStartFrom')]",
              "to": "2050-02-01T00:00:00Z"
            }
          },
          "format": "Csv",
          "deliveryInfo": {
              "destination": {
                "resourceId": "[parameters('storageAccountId')]",
                "container": "[parameters('storageAccountContainer')]",
                "rootFolderPath": "[parameters('storageAccountDirectory')]"
              }
          },
          "definition": {
              "type": "ActualCost",
              "timeframe": "MonthToDate",
              "dataSet": {
                  "granularity": "Daily"
              }
          },
          "partitionData": true
      }
    }
  ],
  "outputs": {
    "exportName": {
      "type": "string",
      "value": "[parameters('exportName')]"
    },
    "exportId": {
      "type": "string",
      "value": "[resourceId('Microsoft.CostManagement/exports', parameters('exportName'))]"
    },
    "storageAccountContainer": {
      "type": "string",
      "value": "[parameters('storageAccountContainer')]"      
    },       
    "storageAccountDirectory": {
      "type": "string",
      "value": "[parameters('storageAccountDirectory')]"      
    }       
  }
}
